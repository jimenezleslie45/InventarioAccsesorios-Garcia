<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Accesorios Garc칤a | Gesti칩n Total Pro</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    /* Estilo General preservado */
    body { background: linear-gradient(135deg, #c4f1db 0%, #ffffff 50%, #888dbd 100%); min-height: 100vh; font-family: 'Poppins', sans-serif; color: #1e293b; }
    .glass-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(0, 242, 255, 0.3); border-radius: 20px; box-shadow: 0 8px 32px rgba(0, 180, 216, 0.1); }
    .tab-active { color: #0ea5e9; border-bottom: 3px solid #0ea5e9; font-weight: 700; }
    .btn-action { background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%); color: white; border-radius: 12px; transition: all 0.2s; box-shadow: 0 4px 15px rgba(58, 123, 213, 0.3); }
    .btn-action:active { transform: scale(0.95); }

    /* LOGIN FONDO NEGRO ORIGINAL */
    #loginScreen { background-color: #000000; position: fixed; inset: 0; z-index: 9999; display: flex; align-items: center; justify-content: center; }
    .neon-card { background: #0a0a0a; border: 2px solid #00f2ff; box-shadow: 0 0 20px rgba(0, 242, 255, 0.5); padding: 40px; border-radius: 20px; width: 320px; text-align: center; }
    .neon-input { background: transparent; border: 1px solid #00f2ff; color: white; padding: 12px; border-radius: 10px; outline: none; width: 100%; margin-bottom: 15px; }
    .neon-input:focus { box-shadow: 0 0 10px #00f2ff; }

    #reader { border: 2px solid #00f2ff !important; border-radius: 15px; overflow: hidden; background: white; }
  </style>
</head>
<body class="p-2 md:p-6">

<div id="loginScreen">
  <div class="neon-card">
    <img src="imagen/Logo.jpg" class="w-24 h-24 mx-auto rounded-full mb-6 border-2 border-[#00f2ff] shadow-[0_0_15px_#00f2ff]" alt="Logo Garc칤a">
    <h2 class="text-[#00f2ff] font-bold mb-6 tracking-widest text-xl uppercase">Accesorios Garc칤a</h2>
    <div class="space-y-4 text-left">
      <input type="text" id="userInput" placeholder="Usuario" class="neon-input uppercase text-sm">
      <input type="password" id="passInput" placeholder="Contrase침a" class="neon-input text-sm">
      <button onclick="intentarLogin()" class="btn-action w-full py-3 mt-4 font-bold uppercase tracking-widest text-xs">ENTRAR</button>
    </div>
    <p id="loginError" class="text-red-500 text-[10px] mt-4 hidden font-bold italic">丘멆잺 DATOS INCORRECTOS</p>
  </div>
</div>

<div id="app" class="hidden max-w-7xl mx-auto">
  <header class="text-center mb-6">
    <img src="imagen/Logo.jpg" alt="Logo" class="w-20 h-20 mx-auto rounded-full shadow-lg mb-2 border-2 border-white">
    <h1 class="text-2xl font-bold text-slate-800 uppercase tracking-tight">Accesorios Garc칤a</h1>
    <p id="roleTag" class="text-[10px] font-bold text-cyan-600 uppercase tracking-widest"></p>
  </header>

  <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-6">
    <div class="glass-card p-4 border-l-4 border-sky-400">
      <p class="text-[9px] font-bold text-slate-400 uppercase">Ventas</p>
      <p id="resVentas" class="text-lg font-bold text-slate-700">$0.00</p>
    </div>
    <div class="glass-card p-4 border-l-4 border-amber-500">
      <p class="text-[9px] font-bold text-amber-600 uppercase italic">Utilidad Rifa</p>
      <p id="resRifas" class="text-lg font-bold text-amber-700">$0.00</p>
    </div>
    <div class="glass-card p-4 border-l-4 border-purple-400">
      <p class="text-[9px] font-bold text-slate-400 uppercase">Por Cobrar (Pedidos)</p>
      <p id="resPedidos" class="text-lg font-bold text-slate-700">$0.00</p>
    </div>
    <div class="glass-card p-4 bg-emerald-600 text-white">
      <p class="text-[9px] font-bold uppercase opacity-80">Ganancia Neta</p>
      <p id="resNeto" class="text-xl font-bold">$0.00</p>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
    <div class="lg:col-span-5 space-y-6">
      <div class="glass-card p-4">
        <h3 class="text-xs font-bold text-cyan-600 uppercase mb-4 italic"><i class="fas fa-barcode mr-2"></i>Esc치ner</h3>
        <div id="reader"></div>
        <div id="scanResult" class="mt-4 p-3 bg-cyan-50 rounded-xl border border-cyan-200 text-xs hidden text-center">
            <p id="stockAlert" class="font-bold"></p>
        </div>
      </div>
      <div class="glass-card p-6">
        <canvas id="chartGarcia" style="max-height: 200px;"></canvas>
      </div>
    </div>

    <div class="lg:col-span-7 space-y-6">
      <div class="glass-card p-6">
        <div class="flex gap-4 mb-6 border-b border-slate-100">
          <button onclick="setTab(1)" id="tab1" class="tab-active pb-2 text-xs uppercase font-bold">Ventas/Stock</button>
          <button onclick="setTab(2)" id="tab2" class="text-slate-400 pb-2 text-xs uppercase font-bold">Rifas</button>
          <button onclick="setTab(3)" id="tab3" class="text-slate-400 pb-2 text-xs uppercase font-bold">Pedidos</button>
        </div>

        <form id="formP" class="space-y-4">
  <input type="text" id="pSku" placeholder="C칩digo SKU" class="w-full p-3 rounded-xl bg-slate-50 ring-1 ring-slate-200 text-sm outline-none">
  
  <div class="flex gap-2">
    <select id="pTipo" class="w-1/3 p-3 rounded-xl bg-slate-50 ring-1 ring-slate-200 text-sm font-bold text-cyan-600">
      <option value="salida">Venta 游닋</option>
      <option value="entrada">Stock 游닌</option>
    </select>
    <input type="number" id="pCant" placeholder="Cant." value="1" min="1" class="w-1/4 p-3 rounded-xl ring-1 ring-slate-200 text-sm outline-none">
    <input type="text" id="pNom" placeholder="Nombre Producto" class="w-2/3 p-3 rounded-xl ring-1 ring-slate-200 text-sm outline-none">
  </div>

  <div class="grid grid-cols-2 gap-2">
    <input type="number" id="pCos" placeholder="Costo $" class="p-3 rounded-xl ring-1 ring-slate-200 text-sm">
    <input type="number" id="pPre" placeholder="Venta $" class="p-3 rounded-xl ring-1 ring-slate-200 text-sm">
  </div>
  
  <button type="button" onclick="registrarMovimiento()" class="w-full btn-action font-bold py-3 uppercase text-xs">Registrar Movimiento</button>
</form>
        

   

        <div id="formRifa" class="hidden space-y-4">
          <input type="hidden" id="editRifaIndex" value="-1">
          <input type="text" id="rNom" placeholder="Nombre de la Rifa" class="w-full p-3 rounded-xl ring-1 ring-amber-300 text-sm outline-none uppercase">
          <div class="grid grid-cols-2 gap-2">
            <input type="number" id="rCosto" placeholder="Costo Premio $" class="p-3 rounded-xl ring-1 ring-amber-300 text-sm">
            <input type="number" id="rCant" placeholder="Boletos Vendidos" class="p-3 rounded-xl ring-1 ring-amber-300 text-sm">
          </div>
          <div class="flex gap-2">
            <button onclick="guardarRifa()" id="btnSaveRifa" class="flex-1 py-3 rounded-xl bg-amber-500 text-white font-bold uppercase text-xs shadow-md">Guardar Rifa</button>
            <button onclick="cancelarEdicionRifa()" id="btnCancelRifa" class="hidden px-4 rounded-xl bg-slate-200 text-slate-600"><i class="fas fa-times"></i></button>
          </div>
        </div>

        

        <div id="formPe" class="hidden space-y-4">
          <input type="hidden" id="editPedidoIndex" value="-1">
          <input type="text" id="peCli" placeholder="Nombre Cliente" class="w-full p-3 rounded-xl ring-1 ring-purple-300 text-sm">
          <input type="text" id="pePro" placeholder="Producto/Detalle" class="w-full p-3 rounded-xl ring-1 ring-purple-300 text-sm">
          <div class="grid grid-cols-2 gap-2">
            <input type="number" id="peTot" placeholder="Total $" class="p-3 rounded-xl ring-1 ring-purple-300 text-sm">
            <input type="number" id="peAnt" placeholder="Anticipo $" class="p-3 rounded-xl ring-1 ring-purple-300 text-sm">
          </div>
          <div class="flex gap-2">
            <button onclick="guardarPedido()" id="btnSavePedido" class="flex-1 py-3 rounded-xl bg-purple-600 text-white font-bold uppercase text-xs">Guardar Pedido</button>
            <button onclick="cancelarEdicionPedido()" id="btnCancelEdit" class="hidden px-4 rounded-xl bg-slate-200 text-slate-600"><i class="fas fa-times"></i></button>
          </div>
        </div>
      </div>

      <div class="glass-card p-4 overflow-hidden">
        <div class="flex justify-between items-center mb-4">
          <h3 id="historialTitulo" class="text-[10px] font-bold text-slate-500 uppercase italic">Historial de Ventas</h3>
          <button onclick="exportarExcel()" class="bg-emerald-600 text-white px-3 py-1 rounded-lg text-[9px] font-bold">EXCEL</button>
        </div>
        <div class="overflow-x-auto max-h-[300px]">
          <table class="w-full text-left text-[11px]">
            <thead class="bg-slate-50 sticky top-0">
              <tr id="theadRow"></tr>
            </thead>
            <tbody id="listaDinamica" class="divide-y divide-slate-100"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const users = { 'proveedor': 'garcia77', 'administrador': 'admin2026', 'encargado': 'ventas01' };
  let DB = JSON.parse(localStorage.getItem('ag_v_final')) || { productos: [], rifas: [], pedidos: [] };
  let myChart;
  let tabActual = 1;

  function intentarLogin() {
    const u = document.getElementById('userInput').value.toLowerCase();
    const p = document.getElementById('passInput').value;
    if(users[u] && users[u] === p) {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('app').classList.remove('hidden');
      document.getElementById('roleTag').innerText = "SESI칍N: " + u;
      initScanner();
      actualizar();
    } else {
      document.getElementById('loginError').classList.remove('hidden');
    }
  }

  function initScanner() {
    const scanner = new Html5QrcodeScanner("reader", { fps: 15, qrbox: 250 });
    scanner.render((text) => {
      document.getElementById('pSku').value = text;
      notificarDisponibles(text);
    });
  }

  // FUNCI칍N: Notificar stock disponible
  function notificarDisponibles(sku) {
    const entradas = DB.productos.filter(p => p.sku === sku && p.tipo === 'entrada').length;
    const salidas = DB.productos.filter(p => p.sku === sku && p.tipo === 'salida').length;
    const stock = entradas - salidas;
    
    const alertBox = document.getElementById('scanResult');
    const alertText = document.getElementById('stockAlert');
    alertBox.classList.remove('hidden');
    alertText.innerText = `PRODUCTO: ${sku} | DISPONIBLES EN STOCK: ${stock}`;
    alertText.className = stock > 0 ? "text-emerald-600 font-bold" : "text-red-500 font-bold";
  }

  function setTab(t) {
  tabActual = t;
  // Control de visibilidad de formularios
  document.getElementById('formP').classList.toggle('hidden', t !== 1);
  document.getElementById('formRifa').classList.toggle('hidden', t !== 2); // Agrega esta l칤nea
  document.getElementById('formPe').classList.toggle('hidden', t !== 3);
  
  [1,2,3].forEach(i => {
    document.getElementById('tab'+i).className = i===t ? "tab-active pb-2 text-xs uppercase font-bold" : "text-slate-400 pb-2 text-xs uppercase font-bold";
  });
  actualizar();
}

  function actualizar() {
    const lista = document.getElementById('listaDinamica');
    const thead = document.getElementById('theadRow');
    lista.innerHTML = '';
    
    let vProd=0, uProdTotal=0, pPendiente=0, uRifasTotal=0;

   if(tabActual === 1) { // VENTAS
    document.getElementById('historialTitulo').innerText = "Historial de Ventas/Stock";
    // Agregamos "Cant." a los encabezados
    thead.innerHTML = '<th class="p-3">Cant.</th><th class="p-3">Producto</th><th class="p-3">Utilidad</th><th class="p-3">Acci칩n</th>';
    
    DB.productos.forEach((p, i) => {
        let u = p.tipo === 'salida' ? (p.pre - p.cos) : 0;
        if(p.tipo === 'salida') { 
            vProd += p.pre; 
            uProdTotal += u; 
        }
        
        lista.innerHTML += `
            <tr>
                <td class="p-3 text-center font-mono bg-slate-50 rounded-l-lg">${p.cant || 1}x</td>
                <td class="p-3 font-bold">${p.nom} <br><span class="text-[10px] text-slate-400">${p.sku || '--'}</span></td>
                <td class="p-3 text-emerald-600 font-bold">$${u.toFixed(2)}</td>
                <td class="p-3 rounded-r-lg">
                    <button onclick="borrarProd(${i})" class="text-red-400 hover:text-red-600 transition-colors">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>`;
    });
}

   else if (tabActual === 2) { // RIFAS
        document.getElementById('historialTitulo').innerText = "Registro de Rifas";
        thead.innerHTML = '<th class="p-3">Nombre Rifa</th><th class="p-3">Utilidad</th><th class="p-3">Acciones</th>';
        DB.rifas.forEach((r, i) => {
            let utilRifa = (r.cant * 10) - r.costo;
            lista.innerHTML += `<tr>
                <td class="p-3 font-bold uppercase">${r.nom}</td>
                <td class="p-3 text-amber-600 font-bold">$${utilRifa.toFixed(2)}</td>
                <td class="p-3 space-x-2">
                    <button onclick="editarRifa(${i})" class="text-amber-500"><i class="fas fa-edit"></i></button>
                    <button onclick="borrarRifa(${i})" class="text-red-400"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        });
    }
    






    else if (tabActual === 3) { // PEDIDOS (CRUD)
        document.getElementById('historialTitulo').innerText = "Gesti칩n de Pedidos";
        thead.innerHTML = '<th class="p-3">Cliente</th><th class="p-3">Debe</th><th class="p-3">Acciones</th>';
        DB.pedidos.forEach((pe, i) => {
            let saldo = pe.total - pe.pagado;
            pPendiente += saldo;
            lista.innerHTML += `<tr>
                <td class="p-3 font-bold">${pe.cliente}<br><span class="text-[9px] text-slate-400">${pe.producto}</span></td>
                <td class="p-3 text-red-500 font-bold">$${saldo.toFixed(2)}</td>
                <td class="p-3 space-x-2">
                    <button onclick="descargarTicket(${i})" class="text-blue-500" title="PDF"><i class="fas fa-file-pdf"></i></button>
                    <button onclick="editarPedido(${i})" class="text-amber-500" title="Editar"><i class="fas fa-edit"></i></button>
                    <button onclick="borrarPedido(${i})" class="text-red-400" title="Borrar"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        });
    }

    DB.rifas.forEach(r => uRifasTotal += (r.cant * 10) - r.costo);
    document.getElementById('resVentas').innerText = `$${vProd.toFixed(2)}`;
    document.getElementById('resRifas').innerText = `$${uRifasTotal.toFixed(2)}`;
    document.getElementById('resPedidos').innerText = `$${pPendiente.toFixed(2)}`;
    document.getElementById('resNeto').innerText = `$${(uProdTotal + uRifasTotal).toFixed(2)}`;

    localStorage.setItem('ag_v_final', JSON.stringify(DB));
    renderChart(uProdTotal, uRifasTotal);
  }

  // --- LOGICA CRUD PEDIDOS ---
  function guardarPedido() {
    const index = parseInt(document.getElementById('editPedidoIndex').value);
    const pe = {
        cliente: document.getElementById('peCli').value.toUpperCase(),
        producto: document.getElementById('pePro').value.toUpperCase(),
        total: parseFloat(document.getElementById('peTot').value) || 0,
        pagado: parseFloat(document.getElementById('peAnt').value) || 0
    };

    if(pe.cliente === "") return alert("Falta nombre del cliente");

    if(index === -1) {
        DB.pedidos.push(pe);
    } else {
        DB.pedidos[index] = pe;
        cancelarEdicionPedido();
    }
    
    actualizar();
    document.getElementById('peCli').value = "";
    document.getElementById('pePro').value = "";
    document.getElementById('peTot').value = "";
    document.getElementById('peAnt').value = "";
  }

  function editarPedido(i) {
    const pe = DB.pedidos[i];
    document.getElementById('peCli').value = pe.cliente;
    document.getElementById('pePro').value = pe.producto;
    document.getElementById('peTot').value = pe.total;
    document.getElementById('peAnt').value = pe.pagado;
    document.getElementById('editPedidoIndex').value = i;
    
    document.getElementById('btnSavePedido').innerText = "Actualizar Pedido";
    document.getElementById('btnCancelEdit').classList.remove('hidden');
    window.scrollTo(0,0);
  }

  function cancelarEdicionPedido() {
    document.getElementById('editPedidoIndex').value = "-1";
    document.getElementById('btnSavePedido').innerText = "Guardar Pedido";
    document.getElementById('btnCancelEdit').classList.add('hidden');
    document.getElementById('peCli').value = "";
    document.getElementById('pePro').value = "";
    document.getElementById('peTot').value = "";
    document.getElementById('peAnt').value = "";
  }

  function borrarPedido(i) { if(confirm("쮼liminar pedido?")) { DB.pedidos.splice(i,1); actualizar(); } }
  function borrarProd(i) { DB.productos.splice(i,1); actualizar(); }

  // --- FUNCI칍N PDF ---
  function descargarTicket(i) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: 'mm', format: [80, 150] }); // Formato ticket
    const pe = DB.pedidos[i];

    doc.setFontSize(12);
    doc.text("ACCESORIOS GARCIA", 40, 10, { align: 'center' });
    doc.setFontSize(8);
    doc.text("------------------------------------------", 40, 15, { align: 'center' });
    doc.text(`CLIENTE: ${pe.cliente}`, 5, 25);
    doc.text(`PRODUCTO: ${pe.producto}`, 5, 30);
    doc.text(`TOTAL: $${pe.total.toFixed(2)}`, 5, 40);
    doc.text(`ANTICIPO: $${pe.pagado.toFixed(2)}`, 5, 45);
    doc.setFontSize(10);
    doc.text(`RESTA: $${(pe.total - pe.pagado).toFixed(2)}`, 5, 55);
    doc.setFontSize(8);
    doc.text("------------------------------------------", 40, 65, { align: 'center' });
    doc.text("Gracias por su preferencia", 40, 75, { align: 'center' });

    doc.save(`Pedido_${pe.cliente}.pdf`);
  }

  // Resto de funciones (Chart, FormP, Excel)
  function renderChart(up, ur) {
    const ctx = document.getElementById('chartGarcia').getContext('2d');
    if(myChart) myChart.destroy();
    myChart = new Chart(ctx, {
      type: 'doughnut',
      data: { labels: ['Ventas', 'Rifas'], datasets: [{ data: [up, ur], backgroundColor: ['#0ea5e9', '#f59e0b'], borderWidth: 0 }] },
      options: { cutout: '70%', plugins: { legend: { position: 'bottom' } } }
    });
  }

  document.getElementById('formP').onsubmit = (e) => {
    e.preventDefault();
    const sku = document.getElementById('pSku').value;
    DB.productos.push({
      sku: sku,
      tipo: document.getElementById('pTipo').value,
      nom: document.getElementById('pNom').value.toUpperCase(),
      cos: parseFloat(document.getElementById('pCos').value) || 0,
      pre: parseFloat(document.getElementById('pPre').value) || 0
    });
    actualizar();
    notificarDisponibles(sku);
    e.target.reset();
  };
   
  // --- LOGICA RIFAS ---
  function guardarRifa() {
  const index = parseInt(document.getElementById('editRifaIndex').value);
  const rifa = {
    nom: document.getElementById('rNom').value.toUpperCase(),
    costo: parseFloat(document.getElementById('rCosto').value) || 0,
    cant: parseInt(document.getElementById('rCant').value) || 0
  };

  if(rifa.nom === "") return alert("Falta nombre de la rifa");

  if(index === -1) {
    DB.rifas.push(rifa); // Crear nueva
  } else {
    DB.rifas[index] = rifa; // Actualizar existente
    cancelarEdicionRifa();
  }
  
  actualizar();
  // Limpiar campos manualmente tras guardar nuevo
  if(index === -1) {
    document.getElementById('rNom').value = "";
    document.getElementById('rCosto').value = "";
    document.getElementById('rCant').value = "";
  }
}

function editarRifa(i) {
  const r = DB.rifas[i];
  document.getElementById('rNom').value = r.nom;
  document.getElementById('rCosto').value = r.costo;
  document.getElementById('rCant').value = r.cant;
  document.getElementById('editRifaIndex').value = i;
  
  document.getElementById('btnSaveRifa').innerText = "Actualizar Rifa";
  document.getElementById('btnCancelRifa').classList.remove('hidden');
  window.scrollTo(0,0); // Sube la pantalla para ver el formulario
}

function cancelarEdicionRifa() {
  document.getElementById('editRifaIndex').value = "-1";
  document.getElementById('btnSaveRifa').innerText = "Guardar Rifa";
  document.getElementById('btnCancelRifa').classList.add('hidden');
  document.getElementById('rNom').value = "";
  document.getElementById('rCosto').value = "";
  document.getElementById('rCant').value = "";
}




  function exportarExcel() {
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(DB.productos), "Ventas");
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(DB.pedidos), "Pedidos");
    XLSX.writeFile(wb, "Reporte_Garcia.xlsx");
  }
</script>
</body>
</html>