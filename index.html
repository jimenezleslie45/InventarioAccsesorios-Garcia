<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Accesorios Garc칤a | Gesti칩n Total Pro</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA46-W-QKLtoQunpeL-qQPjSiW4x8RmxsY",
      authDomain: "inventario-5d03f.firebaseapp.com",
      projectId: "inventario-5d03f",
      storageBucket: "inventario-5d03f.firebasestorage.app",
      messagingSenderId: "229436615048",
      appId: "1:229436615048:web:758e29b38618e16507b23d",
      measurementId: "G-QMWPSXNCQ1"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);

    window.firebaseDB = db;
    window.collection = collection;
    window.addDoc = addDoc;
    window.getDocs = getDocs;
    window.doc = doc;
    window.updateDoc = updateDoc;
    window.deleteDoc = deleteDoc;
    window.query = query;
    window.where = where;
  </script>

  <style>
    /* Estilo General preservado */
    body { background: linear-gradient(135deg, #e7c0d6 0%, #ffffff 50%, #e7adcd 100%); min-height: 100vh; font-family: 'Poppins', sans-serif; color: #1e293b; }
    .glass-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(0, 242, 255, 0.3); border-radius: 20px; box-shadow: 0 8px 32px rgba(0, 180, 216, 0.1); }
    .tab-active { color: #0ea5e9; border-bottom: 3px solid #0ea5e9; font-weight: 700; }
    .btn-action { background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%); color: white; border-radius: 12px; transition: all 0.2s; box-shadow: 0 4px 15px rgba(58, 123, 213, 0.3); }
    .btn-action:active { transform: scale(0.95); }

    /* LOGIN FONDO NEGRO ORIGINAL */
    #loginScreen { background-color: #000000; position: fixed; inset: 0; z-index: 9999; display: flex; align-items: center; justify-content: center; }
    .neon-card { background: #0a0a0a; border: 2px solid #00f2ff; box-shadow: 0 0 20px rgba(0, 242, 255, 0.5); padding: 40px; border-radius: 20px; width: 320px; text-align: center; }
    .neon-input { background: transparent; border: 1px solid #00f2ff; color: white; padding: 12px; border-radius: 10px; outline: none; width: 100%; margin-bottom: 15px; }
    .neon-input:focus { box-shadow: 0 0 10px #00f2ff; }

    #reader { border: 2px solid #00f2ff !important; border-radius: 15px; overflow: hidden; background: white; }

    /* Efectos adicionales para botones y secciones */
    .sidebar-btn { transition: all 0.3s ease; transform-origin: center; }
    .sidebar-btn:hover { transform: translateX(10px) scale(1.05); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); }
    .sidebar-btn:active { transform: translateX(5px) scale(0.98); }

    .glass-card { transition: all 0.3s ease; }
    .glass-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0, 180, 216, 0.2); }

    .modal-content { animation: fadeInUp 0.5s ease-out; }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .btn-pulse { animation: pulse 2s infinite; }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(58, 123, 213, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(58, 123, 213, 0); }
      100% { box-shadow: 0 0 0 0 rgba(58, 123, 213, 0); }
    }

    .section-fade-in { animation: sectionFadeIn 0.6s ease-out; }
    @keyframes sectionFadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
  </style>
</head>
<body class="p-2 md:p-6">

<div id="loginScreen">
  <div class="neon-card">
    <img src="imagen/Logo.jpg" class="w-24 h-24 mx-auto rounded-full mb-6 border-2 border-[#00f2ff] shadow-[0_0_15px_#00f2ff]" alt="Logo Garc칤a">
    <h2 class="text-[#00f2ff] font-bold mb-6 tracking-widest text-xl uppercase">Accesorios Garc칤a</h2>
    <div class="space-y-4 text-left">
      <input type="text" id="userInput" placeholder="Usuario" class="neon-input uppercase text-sm">
      <input type="password" id="passInput" placeholder="Contrase침a" class="neon-input text-sm">
      <button onclick="intentarLogin()" class="btn-action w-full py-3 mt-4 font-bold uppercase tracking-widest text-xs">ENTRAR</button>
    </div>
    <p id="loginError" class="text-red-500 text-[10px] mt-4 hidden font-bold italic">丘멆잺 DATOS INCORRECTOS</p>
  </div>
</div>

<div id="app" class="hidden flex">
  <!-- Sidebar Izquierdo -->
  <aside class="w-64 bg-gradient-to-b from-slate-800 to-slate-900 text-white p-6 shadow-xl min-h-screen">
    <div class="text-center mb-8">
      <img src="imagen/Logo.jpg" alt="Logo" class="w-16 h-16 mx-auto rounded-full shadow-lg mb-2 border-2 border-cyan-400">
      <h2 class="text-lg font-bold uppercase tracking-tight">Accesorios Garc칤a</h2>
      <p id="roleTag" class="text-[10px] font-bold text-cyan-400 uppercase tracking-widest"></p>
    </div>
    <nav class="space-y-2">
      <button onclick="setSection('ventas')" class="sidebar-btn w-full text-left py-3 px-4 rounded-lg bg-slate-700 hover:bg-cyan-600 transition-all duration-300 transform hover:scale-105 shadow-md">
        <i class="fas fa-shopping-cart mr-3"></i>Ventas
      </button>
      <button onclick="setSection('compras')" class="sidebar-btn w-full text-left py-3 px-4 rounded-lg bg-slate-700 hover:bg-cyan-600 transition-all duration-300 transform hover:scale-105 shadow-md">
        <i class="fas fa-truck mr-3"></i>Compras
      </button>
      <button onclick="setSection('pedidos')" class="sidebar-btn w-full text-left py-3 px-4 rounded-lg bg-slate-700 hover:bg-cyan-600 transition-all duration-300 transform hover:scale-105 shadow-md">
        <i class="fas fa-clipboard-list mr-3"></i>Pedidos
      </button>
      <button onclick="setSection('productos')" class="sidebar-btn w-full text-left py-3 px-4 rounded-lg bg-slate-700 hover:bg-cyan-600 transition-all duration-300 transform hover:scale-105 shadow-md">
        <i class="fas fa-box mr-3"></i>Productos
      </button>
      <button onclick="setSection('inventario')" class="sidebar-btn w-full text-left py-3 px-4 rounded-lg bg-slate-700 hover:bg-cyan-600 transition-all duration-300 transform hover:scale-105 shadow-md">
        <i class="fas fa-warehouse mr-3"></i>Inventario
      </button>
      <button onclick="setSection('facturacion')" class="sidebar-btn w-full text-left py-3 px-4 rounded-lg bg-slate-700 hover:bg-cyan-600 transition-all duration-300 transform hover:scale-105 shadow-md">
        <i class="fas fa-file-invoice-dollar mr-3"></i>Facturaci칩n
      </button>
      <button onclick="setSection('reportes')" class="sidebar-btn w-full text-left py-3 px-4 rounded-lg bg-slate-700 hover:bg-cyan-600 transition-all duration-300 transform hover:scale-105 shadow-md">
        <i class="fas fa-chart-bar mr-3"></i>Reportes
      </button>
      <button onclick="mostrarCatalogo()" class="sidebar-btn w-full text-left py-3 px-4 rounded-lg bg-slate-700 hover:bg-pink-600 transition-all duration-300 transform hover:scale-105 shadow-md">
        <i class="fas fa-store mr-3"></i>Cat치logo
      </button>
      <button onclick="mostrarEnlaceCatalogo()" class="sidebar-btn w-full text-left py-3 px-4 rounded-lg bg-slate-700 hover:bg-green-600 transition-all duration-300 transform hover:scale-105 shadow-md">
        <i class="fas fa-link mr-3"></i>Enlace Cat치logo
      </button>
    </nav>
  </aside>

  <!-- Contenido Principal -->
  <main class="flex-1 p-6">
    <header class="text-center mb-6">
      <h1 class="text-2xl font-bold text-slate-800 uppercase tracking-tight">Gesti칩n Total Pro</h1>
    </header>

  <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-6">
    <div class="glass-card p-4 border-l-4 border-sky-400">
      <p class="text-[9px] font-bold text-slate-400 uppercase">Ventas</p>
      <p id="resVentas" class="text-lg font-bold text-slate-700">$0.00</p>
    </div>
    <div class="glass-card p-4 border-l-4 border-amber-500">
      <p class="text-[9px] font-bold text-amber-600 uppercase italic">Utilidad Rifa</p>
      <p id="resRifas" class="text-lg font-bold text-amber-700">$0.00</p>
    </div>
    <div class="glass-card p-4 border-l-4 border-purple-400">
      <p class="text-[9px] font-bold text-slate-400 uppercase">Por Cobrar (Pedidos)</p>
      <p id="resPedidos" class="text-lg font-bold text-slate-700">$0.00</p>
    </div>
    <div class="glass-card p-4 bg-emerald-600 text-white">
      <p class="text-[9px] font-bold uppercase opacity-80">Ganancia Neta</p>
      <p id="resNeto" class="text-xl font-bold">$0.00</p>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
    <div class="lg:col-span-5 space-y-6">
      <div class="glass-card p-4">
        <h3 class="text-xs font-bold text-cyan-600 uppercase mb-4 italic"><i class="fas fa-barcode mr-2"></i>Esc치ner</h3>
        <div id="reader"></div>
        <div id="scanResult" class="mt-4 p-3 bg-cyan-50 rounded-xl border border-cyan-200 text-xs hidden text-center">
            <p id="stockAlert" class="font-bold"></p>
        </div>
      </div>
      <div class="glass-card p-6">
        <canvas id="chartGarcia" style="max-height: 200px;"></canvas>
      </div>
    </div>

    <div class="lg:col-span-7 space-y-6">
      <div class="glass-card p-6">
        <div class="flex gap-4 mb-6 border-b border-slate-100">
          <button onclick="setTab(1)" id="tab1" class="tab-active pb-2 text-xs uppercase font-bold">Ventas/Stock</button>
          <button onclick="setTab(2)" id="tab2" class="text-slate-400 pb-2 text-xs uppercase font-bold">Rifas</button>
          <button onclick="setTab(3)" id="tab3" class="text-slate-400 pb-2 text-xs uppercase font-bold">Pedidos</button>
        </div>

        <form id="formP" class="space-y-4">
  <input type="text" id="pSku" placeholder="C칩digo SKU" class="w-full p-3 rounded-xl bg-slate-50 ring-1 ring-slate-200 text-sm outline-none">
  
  <div class="flex gap-2">
    <select id="pTipo" class="w-1/3 p-3 rounded-xl bg-slate-50 ring-1 ring-slate-200 text-sm font-bold text-cyan-600">
      <option value="salida">Venta 游닋</option>
      <option value="entrada">Stock 游닌</option>
    </select>
    <input type="number" id="pCant" placeholder="Cant." value="1" min="1" class="w-1/4 p-3 rounded-xl ring-1 ring-slate-200 text-sm outline-none">
    <input type="text" id="pNom" placeholder="Nombre Producto" class="w-2/3 p-3 rounded-xl ring-1 ring-slate-200 text-sm outline-none">
  </div>

  <div class="grid grid-cols-2 gap-2">
    <input type="number" id="pCos" placeholder="Costo $" class="p-3 rounded-xl ring-1 ring-slate-200 text-sm">
    <input type="number" id="pPre" placeholder="Venta $" class="p-3 rounded-xl ring-1 ring-slate-200 text-sm">
  </div>
  
  <button type="button" onclick="registrarMovimiento()" class="w-full btn-action font-bold py-3 uppercase text-xs">Registrar Movimiento</button>
</form>
        

   

        <div id="formRifa" class="hidden space-y-4">
          <input type="hidden" id="editRifaIndex" value="-1">
          <input type="text" id="rNom" placeholder="Nombre de la Rifa" class="w-full p-3 rounded-xl ring-1 ring-amber-300 text-sm outline-none uppercase">
          <div class="grid grid-cols-2 gap-2">
            <input type="number" id="rCosto" placeholder="Costo Premio $" class="p-3 rounded-xl ring-1 ring-amber-300 text-sm">
            <input type="number" id="rCant" placeholder="Boletos Vendidos" class="p-3 rounded-xl ring-1 ring-amber-300 text-sm">
          </div>
          <div class="flex gap-2">
            <button onclick="guardarRifa()" id="btnSaveRifa" class="flex-1 py-3 rounded-xl bg-amber-500 text-white font-bold uppercase text-xs shadow-md">Guardar Rifa</button>
            <button onclick="cancelarEdicionRifa()" id="btnCancelRifa" class="hidden px-4 rounded-xl bg-slate-200 text-slate-600"><i class="fas fa-times"></i></button>
          </div>
        </div>

        

        <div id="formPe" class="hidden space-y-4">
  <input type="hidden" id="editPedidoIndex" value="-1">
  
  <div class="flex gap-2">
    <input type="number" id="peCant" placeholder="Cant." value="1" min="1" 
           class="w-1/4 p-3 rounded-xl ring-1 ring-purple-300 text-sm outline-none">
    <input type="text" id="peCli" placeholder="Nombre Cliente" 
           class="w-3/4 p-3 rounded-xl ring-1 ring-purple-300 text-sm outline-none">
  </div>

  <input type="text" id="pePro" placeholder="Producto/Detalle" 
         class="w-full p-3 rounded-xl ring-1 ring-purple-300 text-sm outline-none">
  
  <div class="grid grid-cols-2 gap-2">
    <input type="number" id="peTot" placeholder="Total $" class="p-3 rounded-xl ring-1 ring-purple-300 text-sm">
    <input type="number" id="peAnt" placeholder="Anticipo $" class="p-3 rounded-xl ring-1 ring-purple-300 text-sm">
  </div>

  <div class="flex gap-2">
    <button onclick="guardarPedido()" id="btnSavePedido" class="flex-1 py-3 rounded-xl bg-purple-600 text-white font-bold uppercase text-xs">Guardar Pedido</button>
    <button onclick="cancelarEdicionPedido()" id="btnCancelEdit" class="hidden px-4 rounded-xl bg-slate-200 text-slate-600"><i class="fas fa-times"></i></button>
  </div>
</div>

      <div class="glass-card p-4 overflow-hidden">
        <div class="flex justify-between items-center mb-4">
          <h3 id="historialTitulo" class="text-[10px] font-bold text-slate-500 uppercase italic">Historial de Ventas</h3>
          <button onclick="exportarExcel()" class="bg-emerald-600 text-white px-3 py-1 rounded-lg text-[9px] font-bold">EXCEL</button>
        </div>
        <div class="overflow-x-auto max-h-[300px]">
          <table class="w-full text-left text-[11px]">
            <thead class="bg-slate-50 sticky top-0">
              <tr id="theadRow"></tr>
            </thead>
            <tbody id="listaDinamica" class="divide-y divide-slate-100"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modales para cada secci칩n -->
  <div id="modalVentas" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-2xl p-6 w-full max-w-md transform transition-all duration-300 scale-95 hover:scale-100 shadow-2xl">
      <h3 class="text-xl font-bold text-cyan-600 mb-4 uppercase">Nueva Venta</h3>
      <form id="formNuevaVenta" class="space-y-4">
        <input type="text" id="vSku" placeholder="C칩digo SKU" class="w-full p-3 rounded-xl bg-slate-50 ring-1 ring-slate-200 text-sm outline-none">
        <input type="text" id="vNom" placeholder="Nombre Producto" class="w-full p-3 rounded-xl bg-slate-50 ring-1 ring-slate-200 text-sm outline-none">
        <div class="grid grid-cols-2 gap-2">
          <input type="number" id="vCant" placeholder="Cant." value="1" min="1" class="p-3 rounded-xl ring-1 ring-slate-200 text-sm">
          <input type="number" id="vPre" placeholder="Precio $" class="p-3 rounded-xl ring-1 ring-slate-200 text-sm">
        </div>
        <button type="submit" class="w-full btn-action font-bold py-3 uppercase text-xs">Registrar Venta</button>
      </form>
      <button onclick="cerrarModal('modalVentas')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
    </div>
  </div>

  <div id="modalCompras" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-2xl p-6 w-full max-w-md transform transition-all duration-300 scale-95 hover:scale-100 shadow-2xl">
      <h3 class="text-xl font-bold text-green-600 mb-4 uppercase">Nueva Compra</h3>
      <form id="formNuevaCompra" class="space-y-4">
        <input type="text" id="cNom" placeholder="Nombre Producto" class="w-full p-3 rounded-xl bg-slate-50 ring-1 ring-slate-200 text-sm outline-none">
        <div class="grid grid-cols-2 gap-2">
          <input type="number" id="cCant" placeholder="Cant." value="1" min="1" class="p-3 rounded-xl ring-1 ring-slate-200 text-sm">
          <input type="number" id="cCos" placeholder="Costo $" class="p-3 rounded-xl ring-1 ring-slate-200 text-sm">
        </div>
        <input type="text" id="cProv" placeholder="Proveedor" class="w-full p-3 rounded-xl bg-slate-50 ring-1 ring-slate-200 text-sm outline-none">
        <button type="submit" class="w-full btn-action font-bold py-3 uppercase text-xs">Registrar Compra</button>
      </form>
      <button onclick="cerrarModal('modalCompras')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
    </div>
  </div>

  <div id="modalProductos" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-2xl p-6 w-full max-w-md transform transition-all duration-300 scale-95 hover:scale-100 shadow-2xl">
      <h3 class="text-xl font-bold text-blue-600 mb-4 uppercase">Nuevo Producto</h3>
      <form id="formNuevoProducto" class="space-y-4">
        <input type="text" id="prodSku" placeholder="C칩digo SKU" class="w-full p-3 rounded-xl bg-slate-50 ring-1 ring-slate-200 text-sm outline-none">
        <div class="flex gap-2">
          <select id="prodTipo" class="w-1/3 p-3 rounded-xl bg-slate-50 ring-1 ring-slate-200 text-sm font-bold text-cyan-600">
            <option value="salida">Venta 游닋</option>
            <option value="entrada">Stock 游닌</option>
          </select>
          <input type="number" id="prodCant" placeholder="Cant." value="1" min="1" class="w-1/4 p-3 rounded-xl ring-1 ring-slate-200 text-sm outline-none">
          <input type="text" id="prodNom" placeholder="Nombre Producto" class="w-2/3 p-3 rounded-xl ring-1 ring-slate-200 text-sm outline-none">
        </div>
        <select id="prodCategoria" class="w-full p-3 rounded-xl bg-slate-50 ring-1 ring-slate-200 text-sm font-bold text-purple-600">
          <option value="">Seleccionar Categor칤a</option>
          <option value="calzado-dama">Calzado de Dama</option>
          <option value="calzado-caballero">Calzado de Caballero</option>
          <option value="calzado-nino">Calzado de Ni침o</option>
          <option value="cancan-dama">Ca침clas de Dama</option>
          <option value="cancan-caballero">Ca침clas de Caballero</option>
          <option value="cancan-nino">Ca침clas de Ni침o</option>
          <option value="mochilas-cuero">Mochilas de Cuero</option>
          <option value="pulseras-plata">Pulseras de Plata</option>
        </select>
        <textarea id="prodDesc" placeholder="Descripci칩n del producto" class="w-full p-3 rounded-xl bg-slate-50 ring-1 ring-slate-200 text-sm outline-none" rows="3"></textarea>
        <input type="file" id="prodImagen" accept="image/*" class="w-full p-3 rounded-xl bg-slate-50 ring-1 ring-slate-200 text-sm outline-none">
        <div class="grid grid-cols-2 gap-2">
          <input type="number" id="prodCos" placeholder="Costo $" class="p-3 rounded-xl ring-1 ring-slate-200 text-sm">
          <input type="number" id="prodPre" placeholder="Precio $" class="p-3 rounded-xl ring-1 ring-slate-200 text-sm">
        </div>
        <button type="submit" class="w-full btn-action font-bold py-3 uppercase text-xs">Agregar Producto</button>
      </form>
      <button onclick="cerrarModal('modalProductos')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
    </div>
  </div>

  <div id="modalPedidos" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-2xl p-6 w-full max-w-md transform transition-all duration-300 scale-95 hover:scale-100 shadow-2xl">
      <h3 class="text-xl font-bold text-purple-600 mb-4 uppercase">Nuevo Pedido</h3>
      <form id="formNuevoPedido" class="space-y-4">
        <input type="hidden" id="editPedidoIndexModal" value="-1">
        <div class="flex gap-2">
          <input type="number" id="peCantModal" placeholder="Cant." value="1" min="1" class="w-1/4 p-3 rounded-xl ring-1 ring-purple-300 text-sm outline-none">
          <input type="text" id="peCliModal" placeholder="Nombre Cliente" class="w-3/4 p-3 rounded-xl ring-1 ring-purple-300 text-sm outline-none">
        </div>
        <input type="text" id="peProModal" placeholder="Producto/Detalle" class="w-full p-3 rounded-xl ring-1 ring-purple-300 text-sm outline-none">
        <div class="grid grid-cols-2 gap-2">
          <input type="number" id="peTotModal" placeholder="Total $" class="p-3 rounded-xl ring-1 ring-purple-300 text-sm">
          <input type="number" id="peAntModal" placeholder="Anticipo $" class="p-3 rounded-xl ring-1 ring-purple-300 text-sm">
        </div>
        <div class="flex gap-2">
          <button type="submit" id="btnSavePedidoModal" class="flex-1 py-3 rounded-xl bg-purple-600 text-white font-bold uppercase text-xs">Guardar Pedido</button>
          <button onclick="cancelarEdicionPedidoModal()" id="btnCancelEditModal" class="hidden px-4 rounded-xl bg-slate-200 text-slate-600"><i class="fas fa-times"></i></button>
        </div>
      </form>
      <button onclick="cerrarModal('modalPedidos')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
    </div>
  </div>

  <div id="modalInventario" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-2xl p-6 w-full max-w-4xl transform transition-all duration-300 scale-95 hover:scale-100 shadow-2xl">
      <h3 class="text-xl font-bold text-purple-600 mb-4 uppercase">Inventario Actual</h3>
      <div class="overflow-x-auto max-h-96">
        <table class="w-full text-left text-sm">
          <thead class="bg-slate-50">
            <tr>
              <th class="p-3">SKU</th><th class="p-3">Producto</th><th class="p-3">Stock</th><th class="p-3">Acciones</th>
            </tr>
          </thead>
          <tbody id="inventarioTable"></tbody>
        </table>
      </div>
      <button onclick="cerrarModal('modalInventario')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
    </div>
  </div>

  <div id="modalFacturacion" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-2xl p-6 w-full max-w-md transform transition-all duration-300 scale-95 hover:scale-100 shadow-2xl">
      <h3 class="text-xl font-bold text-red-600 mb-4 uppercase">Generar Factura</h3>
      <form id="formFactura" class="space-y-4">
        <input type="text" id="fCliente" placeholder="Cliente" class="w-full p-3 rounded-xl bg-slate-50 ring-1 ring-slate-200 text-sm outline-none">
        <input type="text" id="fProductos" placeholder="Productos (separados por coma)" class="w-full p-3 rounded-xl bg-slate-50 ring-1 ring-slate-200 text-sm outline-none">
        <input type="number" id="fCant" placeholder="Cantidad Total" value="1" min="1" class="w-full p-3 rounded-xl bg-slate-50 ring-1 ring-slate-200 text-sm outline-none">
        <input type="number" id="fTotal" placeholder="Total $" class="w-full p-3 rounded-xl bg-slate-50 ring-1 ring-slate-200 text-sm outline-none">
        <button type="submit" class="w-full btn-action font-bold py-3 uppercase text-xs">Generar Factura</button>
      </form>
      <button onclick="cerrarModal('modalFacturacion')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
    </div>
  </div>

  <div id="modalReportes" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-2xl p-6 w-full max-w-4xl transform transition-all duration-300 scale-95 hover:scale-100 shadow-2xl">
      <h3 class="text-xl font-bold text-indigo-600 mb-4 uppercase">Reportes y Gr치ficos</h3>
      <canvas id="reportChart" style="max-height: 400px;"></canvas>
      <div class="mt-4 flex gap-2">
        <button onclick="exportarExcel()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg font-bold">Exportar Excel</button>
        <button onclick="exportarPDF()" class="bg-red-600 text-white px-4 py-2 rounded-lg font-bold">Exportar PDF</button>
      </div>
      <button onclick="cerrarModal('modalReportes')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
    </div>
  </div>

  <div id="modalCatalogo" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-2xl p-6 w-full max-w-6xl transform transition-all duration-300 scale-95 hover:scale-100 shadow-2xl">
      <h3 class="text-xl font-bold text-pink-600 mb-4 uppercase">Cat치logo de Productos</h3>
      <div class="mb-4">
        <select id="categoriaFilter" onchange="filtrarCatalogo()" class="w-full p-3 rounded-xl bg-slate-50 ring-1 ring-slate-200 text-sm font-bold text-purple-600">
          <option value="">Todas las Categor칤as</option>
          <option value="calzado-dama">Calzado de Dama</option>
          <option value="calzado-caballero">Calzado de Caballero</option>
          <option value="calzado-nino">Calzado de Ni침o</option>
          <option value="cancan-dama">Ca침clas de Dama</option>
          <option value="cancan-caballero">Ca침clas de Caballero</option>
          <option value="cancan-nino">Ca침clas de Ni침o</option>
          <option value="mochilas-cuero">Mochilas de Cuero</option>
          <option value="pulseras-plata">Pulseras de Plata</option>
        </select>
      </div>
      <div id="catalogoProductos" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-96 overflow-y-auto"></div>
      <button onclick="cerrarModal('modalCatalogo')" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
    </div>
  </div>

  <div id="modalEnlaceCatalogo" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-2xl p-6 w-full max-w-md transform transition-all duration-300 scale-95 hover:scale-100 shadow-2xl">
      <h3 class="text-xl font-bold text-green-600 mb-4 uppercase">Enlace y QR del Cat치logo</h3>
      <p class="text-sm text-slate-600 mb-4">Comparte este enlace o QR para que los clientes vean el cat치logo:</p>
      <input type="text" id="enlaceCatalogo" readonly class="w-full p-3 rounded-xl bg-slate-50 ring-1 ring-slate-200 text-sm mb-4" value="">
      <div class="text-center mb-4">
        <canvas id="qrCatalogo" style="max-width: 200px;"></canvas>
      </div>
      <button onclick="copiarEnlace()" class="w-full btn-action font-bold py-3 uppercase text-xs mb-2">Copiar Enlace</button>
      <button onclick="cerrarModal('modalEnlaceCatalogo')" class="w-full bg-slate-200 text-slate-600 py-3 rounded-xl font-bold uppercase text-xs">Cerrar</button>
    </div>
  </div>
</div>

<script>
  const users = { 'proveedor': 'garcia77', 'administrador': 'admin2026', 'encargado': 'ventas01' };
  let DB = { productos: [], rifas: [], pedidos: [], facturas: [] };
  let myChart;
  let tabActual = 1;
  let isClientMode = false; // Modo cliente para ver solo cat치logo

  // Verificar si es modo cliente (solo cat치logo)
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('mode') === 'cliente') {
    isClientMode = true;
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('app').classList.remove('hidden');
    document.getElementById('app').querySelector('aside').style.display = 'none';
    document.getElementById('app').querySelector('main').style.width = '100%';
    mostrarCatalogo();
  }

  // Firebase initialization (assuming it's loaded)
  let firebaseDB;
  setTimeout(() => {
    if (window.firebaseDB) {
      firebaseDB = window.firebaseDB;
      loadDataFromFirebase();
    }
  }, 1000);

  async function loadDataFromFirebase() {
    try {
      const productosSnap = await getDocs(collection(firebaseDB, 'productos'));
      DB.productos = productosSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

      const rifasSnap = await getDocs(collection(firebaseDB, 'rifas'));
      DB.rifas = rifasSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

      const pedidosSnap = await getDocs(collection(firebaseDB, 'pedidos'));
      DB.pedidos = pedidosSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

      const facturasSnap = await getDocs(collection(firebaseDB, 'facturas'));
      DB.facturas = facturasSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

      actualizar();
    } catch (error) {
      console.error("Error loading data from Firebase:", error);
      // Fallback to localStorage if Firebase fails
      DB = JSON.parse(localStorage.getItem('ag_v_final')) || { productos: [], rifas: [], pedidos: [], facturas: [] };
      actualizar();
    }
  }

  async function saveToFirebase(collectionName, data) {
    if (!firebaseDB) return;
    try {
      await addDoc(collection(firebaseDB, collectionName), data);
    } catch (error) {
      console.error("Error saving to Firebase:", error);
    }
  }

  function intentarLogin() {
    const u = document.getElementById('userInput').value.toLowerCase();
    const p = document.getElementById('passInput').value;
    if(users[u] && users[u] === p) {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('app').classList.remove('hidden');
      document.getElementById('roleTag').innerText = "SESI칍N: " + u;
      initScanner();
      actualizar();
    } else {
      document.getElementById('loginError').classList.remove('hidden');
    }
  }

  function initScanner() {
    // Detectar si es m칩vil
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

    if (isMobile) {
      // Para m칩viles, usar Html5Qrcode directamente para mejor control de c치maras
      const html5QrCode = new Html5Qrcode("reader");

      // Obtener lista de c치maras disponibles
      Html5Qrcode.getCameras().then(devices => {
        if (devices && devices.length) {
          // Crear selector de c치mara
          const cameraSelect = document.createElement('select');
          cameraSelect.id = 'cameraSelect';
          cameraSelect.className = 'w-full p-2 rounded-xl bg-slate-50 ring-1 ring-slate-200 text-sm mb-2';
          cameraSelect.innerHTML = '<option value="">Seleccionar C치mara</option>';

          devices.forEach(device => {
            const option = document.createElement('option');
            option.value = device.id;
            option.text = device.label || `C치mara ${device.id}`;
            cameraSelect.appendChild(option);
          });

          // Insertar selector antes del reader
          const readerDiv = document.getElementById('reader');
          readerDiv.parentNode.insertBefore(cameraSelect, readerDiv);

          cameraSelect.addEventListener('change', (e) => {
            if (e.target.value) {
              html5QrCode.start(e.target.value, {
                fps: 15,
                qrbox: { width: 250, height: 250 }
              }, (decodedText) => {
                document.getElementById('pSku').value = decodedText;
                notificarDisponibles(decodedText);
                // Opcional: detener escaneo despu칠s de leer
                // html5QrCode.stop();
              }).catch(err => {
                console.error("Error al iniciar esc치ner:", err);
              });
            } else {
              html5QrCode.stop();
            }
          });
        }
      }).catch(err => {
        console.error("Error obteniendo c치maras:", err);
        // Fallback al esc치ner b치sico
        const scanner = new Html5QrcodeScanner("reader", { fps: 15, qrbox: 250 });
        scanner.render((text) => {
          document.getElementById('pSku').value = text;
          notificarDisponibles(text);
        });
      });
    } else {
      // Para PC, usar el esc치ner est치ndar
      const scanner = new Html5QrcodeScanner("reader", { fps: 15, qrbox: 250 });
      scanner.render((text) => {
        document.getElementById('pSku').value = text;
        notificarDisponibles(text);
      });
    }
  }

  // FUNCI칍N: Notificar stock disponible
  function notificarDisponibles(sku) {
    const entradas = DB.productos.filter(p => p.sku === sku && p.tipo === 'entrada').length;
    const salidas = DB.productos.filter(p => p.sku === sku && p.tipo === 'salida').length;
    const stock = entradas - salidas;
    
    const alertBox = document.getElementById('scanResult');
    const alertText = document.getElementById('stockAlert');
    alertBox.classList.remove('hidden');
    alertText.innerText = `PRODUCTO: ${sku} | DISPONIBLES EN STOCK: ${stock}`;
    alertText.className = stock > 0 ? "text-emerald-600 font-bold" : "text-red-500 font-bold";
  }

  function setTab(t) {
  tabActual = t;
  // Control de visibilidad de formularios
  document.getElementById('formP').classList.toggle('hidden', t !== 1);
  document.getElementById('formRifa').classList.toggle('hidden', t !== 2); // Agrega esta l칤nea
  document.getElementById('formPe').classList.toggle('hidden', t !== 3);
  
  [1,2,3].forEach(i => {
    document.getElementById('tab'+i).className = i===t ? "tab-active pb-2 text-xs uppercase font-bold" : "text-slate-400 pb-2 text-xs uppercase font-bold";
  });
  actualizar();
}

  function actualizar() {
    const lista = document.getElementById('listaDinamica');
    const thead = document.getElementById('theadRow');
    lista.innerHTML = '';
    
    let vProd=0, uProdTotal=0, pPendiente=0, uRifasTotal=0;

   if(tabActual === 1) { // VENTAS
    document.getElementById('historialTitulo').innerText = "Historial de Ventas/Stock";
    // Agregamos "Cant." a los encabezados
    thead.innerHTML = '<th class="p-3">Cant.</th><th class="p-3">Producto</th><th class="p-3">Utilidad</th><th class="p-3">Acci칩n</th>';
    
    DB.productos.forEach((p, i) => {
        let u = p.tipo === 'salida' ? (p.pre - p.cos) : 0;
        if(p.tipo === 'salida') { 
            vProd += p.pre; 
            uProdTotal += u; 
        }
        
        lista.innerHTML += `
            <tr>
                <td class="p-3 text-center font-mono bg-slate-50 rounded-l-lg">${p.cant || 1}x</td>
                <td class="p-3 font-bold">${p.nom} <br><span class="text-[10px] text-slate-400">${p.sku || '--'}</span></td>
                <td class="p-3 text-emerald-600 font-bold">$${u.toFixed(2)}</td>
                <td class="p-3 rounded-r-lg">
                    <button onclick="borrarProd(${i})" class="text-red-400 hover:text-red-600 transition-colors">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>`;
    });
}

   else if (tabActual === 2) { // RIFAS
        document.getElementById('historialTitulo').innerText = "Registro de Rifas";
        thead.innerHTML = '<th class="p-3">Nombre Rifa</th><th class="p-3">Utilidad</th><th class="p-3">Acciones</th>';
        DB.rifas.forEach((r, i) => {
            let utilRifa = (r.cant * 10) - r.costo;
            lista.innerHTML += `<tr>
                <td class="p-3 font-bold uppercase">${r.nom}</td>
                <td class="p-3 text-amber-600 font-bold">$${utilRifa.toFixed(2)}</td>
                <td class="p-3 space-x-2">
                    <button onclick="editarRifa(${i})" class="text-amber-500"><i class="fas fa-edit"></i></button>
                    <button onclick="borrarRifa(${i})" class="text-red-400"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        });
    }
    






    else if (tabActual === 3) { // PEDIDOS (CRUD)
        document.getElementById('historialTitulo').innerText = "Gesti칩n de Pedidos";
        thead.innerHTML = '<th class="p-3">Cant.</th><th class="p-3">Cliente</th><th class="p-3">Debe</th><th class="p-3">Acciones</th>';
        
        DB.pedidos.forEach((pe, i) => {
            let saldo = pe.total - pe.pagado;
            pPendiente += saldo;
            lista.innerHTML += `<tr>
                <td class="p-3 text-center font-bold bg-slate-50 rounded-l-lg">${pe.cant || 1}x</td>
                <td class="p-3 font-bold">${pe.cliente}<br><span class="text-[9px] text-slate-400">${pe.producto}</span></td>
                <td class="p-3 text-red-500 font-bold">$${saldo.toFixed(2)}</td>
                <td class="p-3 space-x-2 rounded-r-lg">
                    <button onclick="descargarTicket(${i})" class="text-blue-500 hover:scale-110 transition-transform" title="PDF"><i class="fas fa-file-pdf"></i></button>
                    <button onclick="descargarPNG(${i})" class="text-emerald-500 hover:scale-110 transition-transform" title="Imagen PNG"><i class="fas fa-image"></i></button>
                    <button onclick="editarPedido(${i})" class="text-amber-500 hover:scale-110 transition-transform" title="Editar"><i class="fas fa-edit"></i></button>
                    <button onclick="borrarPedido(${i})" class="text-red-400 hover:scale-110 transition-transform" title="Borrar"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        });
    }

    DB.rifas.forEach(r => uRifasTotal += (r.cant * 10) - r.costo);
    document.getElementById('resVentas').innerText = `$${vProd.toFixed(2)}`;
    document.getElementById('resRifas').innerText = `$${uRifasTotal.toFixed(2)}`;
    document.getElementById('resPedidos').innerText = `$${pPendiente.toFixed(2)}`;
    document.getElementById('resNeto').innerText = `$${(uProdTotal + uRifasTotal).toFixed(2)}`;

    localStorage.setItem('ag_v_final', JSON.stringify(DB));
    renderChart(uProdTotal, uRifasTotal);
  }

  // --- LOGICA CRUD PEDIDOS ---
 function guardarPedido() {
    const index = parseInt(document.getElementById('editPedidoIndex').value);
    // Agregamos esta l칤nea para capturar la cantidad de pedidos
    const cant = parseInt(document.getElementById('peCant')?.value) || 1; 

    const pe = {
        cliente: document.getElementById('peCli').value.toUpperCase(),
        producto: document.getElementById('pePro').value.toUpperCase(),
        total: parseFloat(document.getElementById('peTot').value) || 0,
        pagado: parseFloat(document.getElementById('peAnt').value) || 0,
        cant: cant // Guardamos la cantidad en el objeto
    };

    if(pe.cliente === "") return alert("Falta nombre del cliente");

    if(index === -1) {
        DB.pedidos.push(pe);
    } else {
        DB.pedidos[index] = pe;
        cancelarEdicionPedido();
    }
    
    actualizar();
    // Limpiar campos
    document.getElementById('peCli').value = "";
    document.getElementById('pePro').value = "";
    document.getElementById('peTot').value = "";
    document.getElementById('peAnt').value = "";
  }

  function editarPedido(i) {
    const pe = DB.pedidos[i];
    document.getElementById('peCli').value = pe.cliente;
    document.getElementById('pePro').value = pe.producto;
    document.getElementById('peTot').value = pe.total;
    document.getElementById('peAnt').value = pe.pagado;
    document.getElementById('editPedidoIndex').value = i;
    
    document.getElementById('btnSavePedido').innerText = "Actualizar Pedido";
    document.getElementById('btnCancelEdit').classList.remove('hidden');
    window.scrollTo(0,0);
  }

  function cancelarEdicionPedido() {
    document.getElementById('editPedidoIndex').value = "-1";
    document.getElementById('btnSavePedido').innerText = "Guardar Pedido";
    document.getElementById('btnCancelEdit').classList.add('hidden');
    document.getElementById('peCli').value = "";
    document.getElementById('pePro').value = "";
    document.getElementById('peTot').value = "";
    document.getElementById('peAnt').value = "";
  }

  function borrarPedido(i) { if(confirm("쮼liminar pedido?")) { DB.pedidos.splice(i,1); actualizar(); } }
  function borrarProd(i) { DB.productos.splice(i,1); actualizar(); }

  
  // --- FUNCI칍N PDF ---
function descargarTicket(i) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: 'mm', format: [80, 150] }); // Formato ticket
    const pe = DB.pedidos[i];
    const logoUrl = 'imagen/Logo.jpg'; // Ruta de tu logo

    // Crear un objeto de imagen para cargar el logo
    const img = new Image();
    img.src = logoUrl;

    img.onload = function() {
        // 1. Agregar Logo al centro (x: 30, y: 5, ancho: 20, alto: 20)
        // Ajustamos la posici칩n para que el texto no se encime
        doc.addImage(img, 'JPEG', 30, 5, 20, 20);

        // 2. T칤tulo de la empresa (Bajamos la posici칩n Y a 30)
        doc.setFontSize(12);
        doc.text("ACCESORIOS GARCIA", 40, 30, { align: 'center' });
        
        doc.setFontSize(8);
        doc.text("------------------------------------------", 40, 35, { align: 'center' });

        // 3. Informaci칩n del Pedido (Incluyendo Cantidad)
        doc.text(`CANTIDAD: ${pe.cant || 1}`, 5, 45); //
        doc.text(`CLIENTE: ${pe.cliente}`, 5, 50);
        doc.text(`PRODUCTO: ${pe.producto}`, 5, 55);
        
        doc.text(`TOTAL: $${pe.total.toFixed(2)}`, 5, 65);
        doc.text(`ANTICIPO: $${pe.pagado.toFixed(2)}`, 5, 70);
        
        doc.setFontSize(10);
        doc.text(`RESTA: $${(pe.total - pe.pagado).toFixed(2)}`, 5, 80);
        
        doc.setFontSize(8);
        doc.text("------------------------------------------", 40, 90, { align: 'center' });
        doc.text("Gracias por su preferencia", 40, 100, { align: 'center' });

        // Guardar el PDF
        doc.save(`Pedido_${pe.cliente}.pdf`);
    };

    // Manejo de error si el logo no carga
    img.onerror = function() {
        alert("Error al cargar el logo para el PDF. Verifica que la imagen existe en la carpeta imagen/.");
    };
}
 
// --- FUNCI칍N PNG (VA AQU칈 AFUERA) ---
function descargarPNG(i) {
    const pe = DB.pedidos[i];
    const ticketVirtual = document.createElement('div');
    
    // Estilo "fantasma" para generar la imagen sin estorbar el dise침o
    ticketVirtual.style = "width: 300px; padding: 20px; background: white; text-align: center; font-family: sans-serif; position: fixed; left: -9999px; top: 0;";
    
    ticketVirtual.innerHTML = `
        <div style="border: 2px solid #0ea5e9; padding: 15px; border-radius: 15px; background: white;">
            <img src="imagen/Logo.jpg" style="width: 70px; height: 70px; border-radius: 50%; border: 2px solid #0ea5e9; margin-bottom: 10px;">
            <h2 style="margin: 0; color: #1e293b; font-size: 18px; text-transform: uppercase;">Accesorios Garc칤a</h2>
            <p style="font-size: 10px; color: #94a3b8;">------------------------------------------</p>
            <div style="text-align: left; font-size: 13px; color: #334155;">
                <p><b>CANTIDAD:</b> ${pe.cant || 1} unidades</p>
                <p><b>CLIENTE:</b> ${pe.cliente}</p>
                <p><b>PRODUCTO:</b> ${pe.producto}</p>
                <p style="margin-top: 10px;"><b>TOTAL:</b> $${pe.total.toFixed(2)}</p>
                <p><b>ANTICIPO:</b> $${pe.pagado.toFixed(2)}</p>
                <div style="background: #fff1f2; padding: 8px; border-radius: 8px; margin-top: 10px; text-align: center;">
                    <p style="margin: 0; color: #e11d48; font-size: 16px;"><b>RESTA: $${(pe.total - pe.pagado).toFixed(2)}</b></p>
                </div>
            </div>
            <p style="font-size: 10px; color: #94a3b8; margin-top: 15px;">------------------------------------------</p>
            <p style="font-size: 11px; font-weight: bold; color: #0ea5e9;">춰Gracias por tu preferencia!</p>
        </div>
    `;

    document.body.appendChild(ticketVirtual);

    // Peque침o tiempo de espera para que html2canvas capture el logo cargado
    setTimeout(() => {
        html2canvas(ticketVirtual, { useCORS: true }).then(canvas => {
            const link = document.createElement('a');
            link.download = `Ticket_${pe.cliente}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
            document.body.removeChild(ticketVirtual);
        }).catch(err => {
            console.error("Error al generar imagen:", err);
            document.body.removeChild(ticketVirtual);
        });
    }, 500);
}




  // Resto de funciones (Chart, FormP, Excel)
  function renderChart(up, ur) {
    const ctx = document.getElementById('chartGarcia').getContext('2d');
    if(myChart) myChart.destroy();

    // Crear gradientes multicolores para efecto 3D
    const gradient1 = ctx.createLinearGradient(0, 0, 0, 400);
    gradient1.addColorStop(0, '#FF6384');
    gradient1.addColorStop(1, '#FF9F40');

    const gradient2 = ctx.createLinearGradient(0, 0, 0, 400);
    gradient2.addColorStop(0, '#36A2EB');
    gradient2.addColorStop(1, '#4BC0C0');

    const gradient3 = ctx.createLinearGradient(0, 0, 0, 400);
    gradient3.addColorStop(0, '#FFCE56');
    gradient3.addColorStop(1, '#FF9F40');

    myChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Ventas', 'Rifas', 'Pedidos'],
        datasets: [{
          data: [up, ur, parseFloat(document.getElementById('resPedidos').innerText.replace('$', ''))],
          backgroundColor: [gradient1, gradient2, gradient3],
          borderColor: ['#FF6384', '#36A2EB', '#FFCE56'],
          borderWidth: 3,
          hoverBorderWidth: 5,
          hoverOffset: 10
        }]
      },
      options: {
        cutout: '60%',
        plugins: {
          legend: { position: 'bottom', labels: { font: { size: 14 } } },
          tooltip: { backgroundColor: 'rgba(0,0,0,0.8)', titleColor: '#fff', bodyColor: '#fff' }
        },
        animation: {
          animateScale: true,
          animateRotate: true
        }
      }
    });
  }

 
  document.getElementById('formP').onsubmit = (e) => {
    e.preventDefault();
    const sku = document.getElementById('pSku').value;
    const tipo = document.getElementById('pTipo').value;
    const nom = document.getElementById('pNom').value.toUpperCase();
    const cos = parseFloat(document.getElementById('pCos').value) || 0;
    const pre = parseFloat(document.getElementById('pPre').value) || 0;
    // Capturamos la cantidad del input que agregamos
    const cant = parseInt(document.getElementById('pCant').value) || 1;

    if (nom === "") return alert("Nombre de producto obligatorio");

    // Agregamos el producto las veces que diga la cantidad
    for (let i = 0; i < cant; i++) {
        DB.productos.push({
            sku: sku,
            tipo: tipo,
            nom: nom,
            cos: cos,
            pre: pre,
            cant: 1, // Se guarda como 1 unidad para el historial
            fecha: new Date().toISOString()
        });
    }

    actualizar();
    notificarDisponibles(sku);
    e.target.reset();
    document.getElementById('pCant').value = "1"; // Resetear cantidad a 1
  };
   
  // --- LOGICA RIFAS ---
  function guardarRifa() {
  const index = parseInt(document.getElementById('editRifaIndex').value);
  const rifa = {
    nom: document.getElementById('rNom').value.toUpperCase(),
    costo: parseFloat(document.getElementById('rCosto').value) || 0,
    cant: parseInt(document.getElementById('rCant').value) || 0
  };

  if(rifa.nom === "") return alert("Falta nombre de la rifa");

  if(index === -1) {
    DB.rifas.push(rifa); // Crear nueva
  } else {
    DB.rifas[index] = rifa; // Actualizar existente
    cancelarEdicionRifa();
  }
  
  actualizar();
  // Limpiar campos manualmente tras guardar nuevo
  if(index === -1) {
    document.getElementById('rNom').value = "";
    document.getElementById('rCosto').value = "";
    document.getElementById('rCant').value = "";
  }
}

function editarRifa(i) {
  const r = DB.rifas[i];
  document.getElementById('rNom').value = r.nom;
  document.getElementById('rCosto').value = r.costo;
  document.getElementById('rCant').value = r.cant;
  document.getElementById('editRifaIndex').value = i;
  
  document.getElementById('btnSaveRifa').innerText = "Actualizar Rifa";
  document.getElementById('btnCancelRifa').classList.remove('hidden');
  window.scrollTo(0,0); // Sube la pantalla para ver el formulario
}

function cancelarEdicionRifa() {
  document.getElementById('editRifaIndex').value = "-1";
  document.getElementById('btnSaveRifa').innerText = "Guardar Rifa";
  document.getElementById('btnCancelRifa').classList.add('hidden');
  document.getElementById('rNom').value = "";
  document.getElementById('rCosto').value = "";
  document.getElementById('rCant').value = "";
}




  function exportarExcel() {
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(DB.productos), "Ventas");
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(DB.pedidos), "Pedidos");
    XLSX.writeFile(wb, "Reporte_Garcia.xlsx");
  }

  // --- FUNCIONES PARA SIDEBAR Y MODALES ---
  function setSection(section) {
    // Cerrar todos los modales
    ['modalVentas', 'modalCompras', 'modalPedidos', 'modalProductos', 'modalInventario', 'modalFacturacion', 'modalReportes'].forEach(id => {
      document.getElementById(id).classList.add('hidden');
    });
    // Abrir el modal correspondiente
    document.getElementById('modal' + section.charAt(0).toUpperCase() + section.slice(1)).classList.remove('hidden');
    // Cargar datos si necesario
    if (section === 'inventario') cargarInventario();
    if (section === 'reportes') renderReportChart();
  }

  function cerrarModal(modalId) {
    document.getElementById(modalId).classList.add('hidden');
  }

  function cargarInventario() {
    const table = document.getElementById('inventarioTable');
    table.innerHTML = '';
    // Simular stock por SKU
    const stockMap = {};
    DB.productos.forEach(p => {
      if (!stockMap[p.sku]) stockMap[p.sku] = { nom: p.nom, stock: 0 };
      if (p.tipo === 'entrada') stockMap[p.sku].stock += p.cant || 1;
      else stockMap[p.sku].stock -= p.cant || 1;
    });
    Object.keys(stockMap).forEach(sku => {
      const item = stockMap[sku];
      table.innerHTML += `<tr><td class="p-3">${sku}</td><td class="p-3">${item.nom}</td><td class="p-3">${item.stock}</td><td class="p-3"><button class="text-blue-500">Editar</button></td></tr>`;
    });
  }

  function renderReportChart() {
    const ctx = document.getElementById('reportChart').getContext('2d');
    const data = {
      labels: ['Ventas', 'Compras', 'Pedidos Pendientes', 'Productos en Stock'],
      datasets: [{
        label: 'Estad칤sticas',
        data: [parseFloat(document.getElementById('resVentas').innerText.replace('$', '')), 0, parseFloat(document.getElementById('resPedidos').innerText.replace('$', '')), DB.productos.length],
        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'],
        borderColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'],
        borderWidth: 1
      }]
    };
    new Chart(ctx, {
      type: 'bar',
      data: data,
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'top' }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }

  // --- FORM HANDLERS PARA MODALES ---
  document.getElementById('formNuevaVenta').onsubmit = async (e) => {
    e.preventDefault();
    const venta = {
      sku: document.getElementById('vSku').value,
      nom: document.getElementById('vNom').value,
      cant: parseInt(document.getElementById('vCant').value) || 1,
      pre: parseFloat(document.getElementById('vPre').value) || 0,
      tipo: 'salida',
      fecha: new Date().toISOString()
    };
    DB.productos.push(venta);
    await saveToFirebase('productos', venta);
    actualizar();
    cerrarModal('modalVentas');
    e.target.reset();
  };

  document.getElementById('formNuevaCompra').onsubmit = async (e) => {
    e.preventDefault();
    const compra = {
      nom: document.getElementById('cNom').value,
      cant: parseInt(document.getElementById('cCant').value) || 1,
      cos: parseFloat(document.getElementById('cCos').value) || 0,
      prov: document.getElementById('cProv').value,
      tipo: 'entrada',
      fecha: new Date().toISOString()
    };
    DB.productos.push(compra);
    await saveToFirebase('productos', compra);
    actualizar();
    cerrarModal('modalCompras');
    e.target.reset();
  };

  document.getElementById('formNuevoProducto').onsubmit = async (e) => {
    e.preventDefault();
    const nom = document.getElementById('prodNom').value.toUpperCase();
    const categoria = document.getElementById('prodCategoria').value;
    const desc = document.getElementById('prodDesc').value;
    const imagenFile = document.getElementById('prodImagen').files[0];

    if (nom === "") return alert("Nombre de producto obligatorio");
    if (categoria === "") return alert("Selecciona una categor칤a");

    let imagenBase64 = '';
    if (imagenFile) {
      imagenBase64 = await new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.readAsDataURL(imagenFile);
      });
    }

    const producto = {
      sku: document.getElementById('prodSku').value,
      tipo: document.getElementById('prodTipo').value,
      nom: nom,
      categoria: categoria,
      desc: desc,
      imagen: imagenBase64,
      cos: parseFloat(document.getElementById('prodCos').value) || 0,
      pre: parseFloat(document.getElementById('prodPre').value) || 0,
      cant: parseInt(document.getElementById('prodCant').value) || 1,
      fecha: new Date().toISOString()
    };
    DB.productos.push(producto);
    await saveToFirebase('productos', producto);
    actualizar();
    cerrarModal('modalProductos');
    e.target.reset();
  };

  document.getElementById('formFactura').onsubmit = async (e) => {
    e.preventDefault();
    const factura = {
      cliente: document.getElementById('fCliente').value,
      productos: document.getElementById('fProductos').value,
      cant: parseInt(document.getElementById('fCant').value) || 1,
      total: parseFloat(document.getElementById('fTotal').value) || 0,
      fecha: new Date().toISOString()
    };
    DB.facturas = DB.facturas || [];
    DB.facturas.push(factura);
    await saveToFirebase('facturas', factura);

    // Generar factura visual con logo
    generarFacturaVisual(factura);

    cerrarModal('modalFacturacion');
    e.target.reset();
  };

  document.getElementById('formNuevoPedido').onsubmit = async (e) => {
    e.preventDefault();
    const pedido = {
      cliente: document.getElementById('peCliModal').value.toUpperCase(),
      producto: document.getElementById('peProModal').value.toUpperCase(),
      total: parseFloat(document.getElementById('peTotModal').value) || 0,
      pagado: parseFloat(document.getElementById('peAntModal').value) || 0,
      cant: parseInt(document.getElementById('peCantModal').value) || 1,
      fecha: new Date().toISOString()
    };

    if(pedido.cliente === "") return alert("Falta nombre del cliente");

    DB.pedidos.push(pedido);
    await saveToFirebase('pedidos', pedido);
    actualizar();
    cerrarModal('modalPedidos');
    e.target.reset();
  };

  function cancelarEdicionPedidoModal() {
    document.getElementById('editPedidoIndexModal').value = "-1";
    document.getElementById('btnSavePedidoModal').innerText = "Guardar Pedido";
    document.getElementById('btnCancelEditModal').classList.add('hidden');
    document.getElementById('peCliModal').value = "";
    document.getElementById('peProModal').value = "";
    document.getElementById('peTotModal').value = "";
    document.getElementById('peAntModal').value = "";
  }

  function exportarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text("Reporte de Accesorios Garc칤a", 20, 20);
    doc.text(`Ventas: ${document.getElementById('resVentas').innerText}`, 20, 40);
    doc.text(`Pedidos Pendientes: ${document.getElementById('resPedidos').innerText}`, 20, 50);
    doc.save("Reporte_Garcia.pdf");
  }

  // --- FUNCIONES PARA CAT츼LOGO ---
  function mostrarCatalogo() {
    document.getElementById('modalCatalogo').classList.remove('hidden');
    filtrarCatalogo();
  }

  function filtrarCatalogo() {
    const categoria = document.getElementById('categoriaFilter').value;
    const container = document.getElementById('catalogoProductos');
    container.innerHTML = '';

    let productosFiltrados = DB.productos.filter(p => p.tipo === 'entrada'); // Solo productos en stock

    if (categoria) {
      productosFiltrados = productosFiltrados.filter(p => p.categoria === categoria);
    }

    productosFiltrados.forEach(p => {
      const stock = DB.productos.filter(prod => prod.sku === p.sku && prod.tipo === 'entrada').length -
                   DB.productos.filter(prod => prod.sku === p.sku && prod.tipo === 'salida').length;

      if (stock > 0) {
        const imagenSrc = p.imagen || 'imagen/Logo.jpg'; // Fallback al logo si no hay imagen
        container.innerHTML += `
          <div class="glass-card p-4 hover:scale-105 transition-transform">
            <img src="${imagenSrc}" alt="${p.nom}" class="w-full h-32 object-cover rounded-lg mb-3">
            <h4 class="font-bold text-lg text-slate-800">${p.nom}</h4>
            <p class="text-sm text-slate-600 mb-2">${p.desc || 'Sin descripci칩n'}</p>
            <p class="text-sm text-slate-600">Categor칤a: ${p.categoria || 'Sin categor칤a'}</p>
            <p class="text-lg font-bold text-emerald-600">$${p.pre.toFixed(2)}</p>
            <p class="text-sm text-slate-500">Stock disponible: ${stock}</p>
          </div>
        `;
      }
    });

    if (productosFiltrados.length === 0) {
      container.innerHTML = '<p class="text-center text-slate-500">No hay productos en esta categor칤a</p>';
    }
  }

  // --- FUNCIONES PARA ENLACE Y QR DEL CAT츼LOGO ---
  function mostrarEnlaceCatalogo() {
    const enlace = window.location.origin + window.location.pathname + '?mode=cliente';
    document.getElementById('enlaceCatalogo').value = enlace;
    document.getElementById('modalEnlaceCatalogo').classList.remove('hidden');

    // Generar QR
    const canvas = document.getElementById('qrCatalogo');
    QRCode.toCanvas(canvas, enlace, { width: 200, height: 200 }, function (error) {
      if (error) console.error(error);
    });
  }

  function copiarEnlace() {
    const enlaceInput = document.getElementById('enlaceCatalogo');
    enlaceInput.select();
    document.execCommand('copy');
    alert('Enlace copiado al portapapeles');
  }

  // --- FUNCI칍N PARA GENERAR FACTURA VISUAL CON LOGO ---
  function generarFacturaVisual(factura) {
    const facturaVirtual = document.createElement('div');

    // Estilo para la factura
    facturaVirtual.style = "width: 400px; padding: 20px; background: white; text-align: center; font-family: sans-serif; position: fixed; left: -9999px; top: 0; border: 2px solid #0ea5e9; border-radius: 15px;";

    facturaVirtual.innerHTML = `
        <div style="text-align: center;">
            <img src="imagen/Logo.jpg" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid #0ea5e9; margin-bottom: 15px;">
            <h1 style="margin: 0; color: #1e293b; font-size: 24px; text-transform: uppercase; font-weight: bold;">Accesorios Garc칤a</h1>
            <p style="font-size: 12px; color: #94a3b8; margin: 5px 0;">Factura de Venta</p>
            <p style="font-size: 10px; color: #94a3b8;">------------------------------------------</p>
        </div>
        <div style="text-align: left; font-size: 14px; color: #334155; margin-top: 20px;">
            <p><b>Cliente:</b> ${factura.cliente}</p>
            <p><b>Productos:</b> ${factura.productos}</p>
            <p><b>Cantidad Total:</b> ${factura.cant} unidades</p>
            <p><b>Total:</b> $${factura.total.toFixed(2)}</p>
            <p><b>Fecha:</b> ${new Date(factura.fecha).toLocaleDateString()}</p>
        </div>
        <p style="font-size: 10px; color: #94a3b8; margin-top: 20px;">------------------------------------------</p>
        <p style="font-size: 12px; font-weight: bold; color: #0ea5e9;">춰Gracias por su preferencia!</p>
    `;

    document.body.appendChild(facturaVirtual);

    // Peque침o tiempo de espera para que html2canvas capture el logo cargado
    setTimeout(() => {
        html2canvas(facturaVirtual, { useCORS: true }).then(canvas => {
            const link = document.createElement('a');
            link.download = `Factura_${factura.cliente}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
            document.body.removeChild(facturaVirtual);
        }).catch(err => {
            console.error("Error al generar factura:", err);
            document.body.removeChild(facturaVirtual);
        });
    }, 500);
  }
</script>
</body>
</html>